module strategy/pack/modules

imports
  org.strategoxt.imp.debuggers.stratego.runtime


imports
  util/config/options
  strategy/pack/graph
  lang/dynamic-rules
  util/config/common
  util/config/verbose


strategies
  pack-options =
    s-enter(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "pack-options", "33,2,44,51")
    ; s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "34,4,44,51")
    ; (s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "34,4,36,57")
       ; ArgOption(
           s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "34,14,34,31")
           ; (s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "34,14,34,17") ; "-I"
              + s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "34,21,34,31") ; "--Include")
         , s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "35,1,35,47")
           ; (s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "35,1,35,42")
              ; where(s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "35,7,35,41")
                      ; <(s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "35,8,35,20") ; extend-config)> ( "-I"
                                                                                                                                      , [ "-I"
                                                                                                                                        , <s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "35,37,35,38") ; id>
                                                                                                                                        ]
                                                                                                                                      )))
           ; s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "35,45,35,47")
           ; !()
         , s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "36,1,36,56")
           ; !"-I d | --Include d   Include modules from directory d"
         )
       + s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "38,4,44,51")
         ; (s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "38,4,40,53")
            ; Option(
                s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "38,11,38,30")
                ; (s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "38,11,38,19") ; "--nodep"
                   + s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "38,23,38,30") ; "-nodep")
              , s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "39,1,39,39")
                ; (s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "39,1,39,34")
                   ; where(s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "39,7,39,33")
                           ; <(s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "39,8,39,17") ; set-config)> ("-nodep", "")))
                ; s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "39,37,39,39")
                ; !()
              , s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "40,1,40,52")
                ; !"--nodep              Don't create dependency file"
              )
            + s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "42,4,44,51")
              ; ArgOption(
                  s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "42,14,42,36")
                  ; (s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "42,14,42,20") ; "--dep"
                     + s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "42,24,42,36")
                       ; (s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "42,24,42,27") ; "-d"
                          + s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "42,31,42,36") ; "-dep"))
                , s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "43,1,43,39")
                  ; (s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "43,1,43,34")
                     ; where(s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "43,7,43,33")
                             ; <(s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "43,8,43,17") ; set-config)> ( "-dep"
                                                                                                                                          , <s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "43,30,43,31") ; id>
                                                                                                                                          )))
                  ; s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "43,37,43,39")
                  ; !()
                , s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "44,1,44,50")
                  ; !"--dep f | -d f       Write dependency to file f"
                )))
    < s-exit(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "pack-options", "33,2,44,51")
    + s-exit(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "pack-options", "33,2,44,51")
      ; fail

  pack-modules(pack : ( term -> term ) * term -> term) =
    s-enter(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "pack-modules", "46,2,48,48")
    ; s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "47,6,48,48")
    ; (s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "47,6,47,29")
       ; pack-modules(
           s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "47,19,47,22") ; pack
         , s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "47,25,47,28") ; fail
         )
       <+ s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "48,9,48,48")
          ; <(s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "48,10,48,20") ; fatal-error)> ["Packing modules failed"])
    < s-exit(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "pack-modules", "46,2,48,48")
    + s-exit(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "pack-modules", "46,2,48,48")
      ; fail

  pack-modules(pack : ( term -> term ) * term -> term, dep-base) =
    s-enter(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "pack-modules", "50,2,60,4")
    ; s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "51,4,60,4")
    ; option-wrap(
        s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "51,16,51,41")
        ; (s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "51,16,51,27") ; pack-options
           <+ s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "51,32,51,41") ; io-options)
      , s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "52,6,59,58")
        ; (s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "52,6,52,58")
           ; (s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "52,7,52,49")
              ; (s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "52,7,52,42")
                 ; <(s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "52,8,52,36")
                     ; (s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "52,8,52,17") ; get-config)
                     ; s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "52,20,52,36")
                     ; filter(
                         s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "52,27,52,35")
                         ; not(s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "52,31,52,34") ; "-I")
                       ))> "-I"
                 <+ s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "52,47,52,49")
                    ; ![])) => path)
        ; s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "53,8,59,58")
        ; (s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "53,8,53,48")
           ; (s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "53,9,53,37")
              ; (s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "53,9,53,25")
                 ; <(s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "53,10,53,19") ; get-config)> "-i"
                 <+ s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "53,30,53,37")
                    ; !stdin())) => infile)
        ; s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "54,8,59,58")
        ; (s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "54,8,54,50")
           ; (s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "54,9,54,38")
              ; (s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "54,9,54,25")
                 ; <(s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "54,10,54,19") ; get-config)> "-o"
                 <+ s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "54,30,54,38")
                    ; !stdout())) => outfile)
        ; s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "55,8,59,58")
        ; (s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "55,8,55,44")
           ; (s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "55,8,55,27")
              ; <(s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "55,9,55,19")
                  ; pack(
                      s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "55,14,55,18") ; !path
                    ))> infile) => (files, spec))
        ; s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "56,8,59,58")
        ; (s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "56,9,57,43")
           ; (s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "56,9,56,61")
              ; (s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "56,9,56,25")
                 ; <(s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "56,10,56,19") ; get-config)> "-b")
              ; s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "56,28,56,61")
              ; <(s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "56,29,56,45") ; WriteToBinaryFile)> (outfile, spec)
              <+ s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "57,12,57,43")
                 ; <(s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "57,13,57,27") ; WriteToTextFile)> (outfile, spec)))
        ; s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "58,8,59,58")
        ; try(
            s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "58,12,59,57")
            ; (s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "58,12,58,83")
               ; (s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "58,13,58,71")
                  ; (s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "58,13,58,31")
                     ; <(s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "58,14,58,23") ; get-config)> "-dep"
                     <+ s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "58,36,58,71")
                        ; (s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "58,36,58,61")
                           ; not(s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "58,40,58,60")
                                 ; <(s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "58,41,58,50") ; get-config)> "-nodep"))
                        ; s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "58,64,58,71")
                        ; dep-base)) => depfile)
            ; s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "59,14,59,57")
            ; <(s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "59,15,59,39")
                ; create-dep-file(
                    s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "59,31,59,38") ; !depfile
                  ))> (outfile, files)
          )
      )
    < s-exit(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "pack-modules", "50,2,60,4")
    + s-exit(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "pack-modules", "50,2,60,4")
      ; fail

  create-dep-file(dep-base) :
    (outfile, files) -> <r-exit(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "create-dep-file", "62,2,67,14")> (outfile, files)
    where r-enter(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "create-dep-file", "62,2,67,14")
          <+ r-exit(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "create-dep-file", "62,2,67,14")
             ; fail
    where s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "64,10,67,14")
          ; (s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "64,10,64,34")
             ; (s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "64,10,64,27")
                ; <(s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "64,11,64,18") ; dep-base)> outfile) => out)
          ; s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "65,3,67,14")
          ; (s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "65,3,65,52")
             ; (s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "65,3,65,45")
                ; <(s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "65,4,65,8") ; fopen)> ( <s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "65,13,65,25") ; add-extension> (out, "dep")
                                                                                                                       , "w"
                                                                                                                       )) => dep)
          ; s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "66,3,67,14")
          ; (s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "66,3,66,68")
             ; <(s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "66,4,66,11") ; fprintnl)> ( dep
                                                                                                                        , [out|<s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "66,28,66,50")
                                                                                                                                ; separate-by(
                                                                                                                                    s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "66,40,66,49")
                                                                                                                                    ; !" \\\n\t"
                                                                                                                                  )> [" :"|files]]
                                                                                                                        ))
          ; s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "67,3,67,14")
          ; <(s-step(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "67,4,67,9") ; fclose)> dep
          <+ r-exit(|"strategoxt/stratego-libraries/lib/spec/strategy/pack/modules.str", "create-dep-file", "62,2,67,14")
             ; fail