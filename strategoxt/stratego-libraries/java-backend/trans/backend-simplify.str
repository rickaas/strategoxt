module backend-simplify

imports
  org.strategoxt.imp.debuggers.stratego.runtime


imports
  libstratego-lib
  libstrc
  lib/dr-scoping
  split-large-strategies


signature
  constructors
    Meta     : List(Term) -> Term
    Filename : Str -> Term


strategies
  main-backend-simplify =
    s-enter(
    | "strategoxt/stratego-libraries/java-backend/trans/backend-simplify.str"
    , "main-backend-simplify"
    , "17"
    , "2"
    , "18"
    , "28"
    )
    ; s-step(
      | "strategoxt/stratego-libraries/java-backend/trans/backend-simplify.str"
      , "18"
      , "4"
      , "18"
      , "28"
      )
    ; io-wrap(
        s-step(
        | "strategoxt/stratego-libraries/java-backend/trans/backend-simplify.str"
        , "18"
        , "12"
        , "18"
        , "27"
        )
        ; backend-simplify
      )
    < s-exit(
      | "strategoxt/stratego-libraries/java-backend/trans/backend-simplify.str"
      , "main-backend-simplify"
      , "17"
      , "2"
      , "18"
      , "28"
      )
    + s-exit(
      | "strategoxt/stratego-libraries/java-backend/trans/backend-simplify.str"
      , "main-backend-simplify"
      , "17"
      , "2"
      , "18"
      , "28"
      )
      ; fail

  backend-simplify =
    s-enter(
    | "strategoxt/stratego-libraries/java-backend/trans/backend-simplify.str"
    , "backend-simplify"
    , "20"
    , "2"
    , "30"
    , "4"
    )
    ; s-step(
      | "strategoxt/stratego-libraries/java-backend/trans/backend-simplify.str"
      , "21"
      , "4"
      , "30"
      , "4"
      )
    ; dr-scope-all-verbose(
        s-step(
        | "strategoxt/stratego-libraries/java-backend/trans/backend-simplify.str"
        , "22"
        , "6"
        , "29"
        , "26"
        )
        ; (s-step(
           | "strategoxt/stratego-libraries/java-backend/trans/backend-simplify.str"
           , "22"
           , "6"
           , "22"
           , "29"
           )
           ; dollars-for-capitals-top)
        ; s-step(
          | "strategoxt/stratego-libraries/java-backend/trans/backend-simplify.str"
          , "23"
          , "6"
          , "29"
          , "26"
          )
        ; (s-step(
           | "strategoxt/stratego-libraries/java-backend/trans/backend-simplify.str"
           , "23"
           , "6"
           , "23"
           , "27"
           )
           ; split-large-strategies)
        ; s-step(
          | "strategoxt/stratego-libraries/java-backend/trans/backend-simplify.str"
          , "24"
          , "6"
          , "29"
          , "26"
          )
        ; (s-step(
           | "strategoxt/stratego-libraries/java-backend/trans/backend-simplify.str"
           , "24"
           , "6"
           , "24"
           , "21"
           )
           ; lift-definitions)
        ; s-step(
          | "strategoxt/stratego-libraries/java-backend/trans/backend-simplify.str"
          , "25"
          , "6"
          , "29"
          , "26"
          )
        ; (s-step(
           | "strategoxt/stratego-libraries/java-backend/trans/backend-simplify.str"
           , "25"
           , "6"
           , "25"
           , "17"
           )
           ; canonicalize)
        ; s-step(
          | "strategoxt/stratego-libraries/java-backend/trans/backend-simplify.str"
          , "26"
          , "6"
          , "29"
          , "26"
          )
        ; (s-step(
           | "strategoxt/stratego-libraries/java-backend/trans/backend-simplify.str"
           , "26"
           , "6"
           , "26"
           , "14"
           )
           ; simplify1)
        ; s-step(
          | "strategoxt/stratego-libraries/java-backend/trans/backend-simplify.str"
          , "27"
          , "6"
          , "29"
          , "26"
          )
        ; (s-step(
           | "strategoxt/stratego-libraries/java-backend/trans/backend-simplify.str"
           , "27"
           , "6"
           , "27"
           , "28"
           )
           ; mark-bound-unbound-vars)
        ; s-step(
          | "strategoxt/stratego-libraries/java-backend/trans/backend-simplify.str"
          , "28"
          , "6"
          , "29"
          , "26"
          )
        ; (s-step(
           | "strategoxt/stratego-libraries/java-backend/trans/backend-simplify.str"
           , "28"
           , "6"
           , "28"
           , "23"
           )
           ; escaping-variables)
        ; s-step(
          | "strategoxt/stratego-libraries/java-backend/trans/backend-simplify.str"
          , "29"
          , "6"
          , "29"
          , "26"
          )
        ; remove-closure-allocs
      )
    < s-exit(
      | "strategoxt/stratego-libraries/java-backend/trans/backend-simplify.str"
      , "backend-simplify"
      , "20"
      , "2"
      , "30"
      , "4"
      )
    + s-exit(
      | "strategoxt/stratego-libraries/java-backend/trans/backend-simplify.str"
      , "backend-simplify"
      , "20"
      , "2"
      , "30"
      , "4"
      )
      ; fail


rules

  dollars-for-capitals-top =
    s-enter(
    | "strategoxt/stratego-libraries/java-backend/trans/backend-simplify.str"
    , "dollars-for-capitals-top"
    , "38"
    , "2"
    , "43"
    , "5"
    )
    ; s-step(
      | "strategoxt/stratego-libraries/java-backend/trans/backend-simplify.str"
      , "39"
      , "4"
      , "43"
      , "5"
      )
    ; topdown(
        s-step(
        | "strategoxt/stratego-libraries/java-backend/trans/backend-simplify.str"
        , "39"
        , "12"
        , "43"
        , "4"
        )
        ; try(
            s-step(
            | "strategoxt/stratego-libraries/java-backend/trans/backend-simplify.str"
            , "40"
            , "6"
            , "42"
            , "42"
            )
            ; (s-step(
               | "strategoxt/stratego-libraries/java-backend/trans/backend-simplify.str"
               , "40"
               , "6"
               , "40"
               , "31"
               )
               ; SVar(
                   s-step(
                   | "strategoxt/stratego-libraries/java-backend/trans/backend-simplify.str"
                   , "40"
                   , "11"
                   , "40"
                   , "30"
                   )
                   ; dollars-for-capitals
                 )
               + s-step(
                 | "strategoxt/stratego-libraries/java-backend/trans/backend-simplify.str"
                 , "41"
                 , "6"
                 , "42"
                 , "42"
                 )
                 ; (s-step(
                    | "strategoxt/stratego-libraries/java-backend/trans/backend-simplify.str"
                    , "41"
                    , "6"
                    , "41"
                    , "44"
                    )
                    ; SDefT(
                        s-step(
                        | "strategoxt/stratego-libraries/java-backend/trans/backend-simplify.str"
                        , "41"
                        , "12"
                        , "41"
                        , "31"
                        )
                        ; dollars-for-capitals
                      , s-step(
                        | "strategoxt/stratego-libraries/java-backend/trans/backend-simplify.str"
                        , "41"
                        , "34"
                        , "41"
                        , "35"
                        )
                        ; id
                      , s-step(
                        | "strategoxt/stratego-libraries/java-backend/trans/backend-simplify.str"
                        , "41"
                        , "38"
                        , "41"
                        , "39"
                        )
                        ; id
                      , s-step(
                        | "strategoxt/stratego-libraries/java-backend/trans/backend-simplify.str"
                        , "41"
                        , "42"
                        , "41"
                        , "43"
                        )
                        ; id
                      )
                    + s-step(
                      | "strategoxt/stratego-libraries/java-backend/trans/backend-simplify.str"
                      , "42"
                      , "6"
                      , "42"
                      , "42"
                      )
                      ; ExtSDef(
                          s-step(
                          | "strategoxt/stratego-libraries/java-backend/trans/backend-simplify.str"
                          , "42"
                          , "14"
                          , "42"
                          , "33"
                          )
                          ; dollars-for-capitals
                        , s-step(
                          | "strategoxt/stratego-libraries/java-backend/trans/backend-simplify.str"
                          , "42"
                          , "36"
                          , "42"
                          , "37"
                          )
                          ; id
                        , s-step(
                          | "strategoxt/stratego-libraries/java-backend/trans/backend-simplify.str"
                          , "42"
                          , "40"
                          , "42"
                          , "41"
                          )
                          ; id
                        )))
          )
      )
    < s-exit(
      | "strategoxt/stratego-libraries/java-backend/trans/backend-simplify.str"
      , "dollars-for-capitals-top"
      , "38"
      , "2"
      , "43"
      , "5"
      )
    + s-exit(
      | "strategoxt/stratego-libraries/java-backend/trans/backend-simplify.str"
      , "dollars-for-capitals-top"
      , "38"
      , "2"
      , "43"
      , "5"
      )
      ; fail

  dollars-for-capitals =
    s-enter(
    | "strategoxt/stratego-libraries/java-backend/trans/backend-simplify.str"
    , "dollars-for-capitals"
    , "45"
    , "2"
    , "49"
    , "6"
    )
    ; s-step(
      | "strategoxt/stratego-libraries/java-backend/trans/backend-simplify.str"
      , "47"
      , "4"
      , "49"
      , "6"
      )
    ; if s-step(
         | "strategoxt/stratego-libraries/java-backend/trans/backend-simplify.str"
         , "47"
         , "7"
         , "47"
         , "42"
         )
         ; not(s-step(
               | "strategoxt/stratego-libraries/java-backend/trans/backend-simplify.str"
               , "47"
               , "11"
               , "47"
               , "41"
               )
               ; string-starts-with(|"SRTS_EXT")) then
        s-step(
        | "strategoxt/stratego-libraries/java-backend/trans/backend-simplify.str"
        , "48"
        , "6"
        , "48"
        , "31"
        )
        ; escape(
            s-step(
            | "strategoxt/stratego-libraries/java-backend/trans/backend-simplify.str"
            , "48"
            , "13"
            , "48"
            , "30"
            )
            ; dollar-for-capital
          )
      end
    < s-exit(
      | "strategoxt/stratego-libraries/java-backend/trans/backend-simplify.str"
      , "dollars-for-capitals"
      , "45"
      , "2"
      , "49"
      , "6"
      )
    + s-exit(
      | "strategoxt/stratego-libraries/java-backend/trans/backend-simplify.str"
      , "dollars-for-capitals"
      , "45"
      , "2"
      , "49"
      , "6"
      )
      ; fail

  dollar-for-capital(rec) :
    [c|cs] -> <r-exit(
               | "strategoxt/stratego-libraries/java-backend/trans/backend-simplify.str"
               , "dollar-for-capital"
               , "51"
               , "2"
               , "52"
               , "53"
               )> ['$', c|<s-step(
                           | "strategoxt/stratego-libraries/java-backend/trans/backend-simplify.str"
                           , "52"
                           , "27"
                           , "52"
                           , "29"
                           )
                           ; rec> cs]
    where r-enter(|"strategoxt/stratego-libraries/java-backend/trans/backend-simplify.str", "dollar-for-capital", "51,2,52,53")
          <+ r-exit(
             | "strategoxt/stratego-libraries/java-backend/trans/backend-simplify.str"
             , "dollar-for-capital"
             , "51"
             , "2"
             , "52"
             , "53"
             )
             ; fail
    where s-step(
          | "strategoxt/stratego-libraries/java-backend/trans/backend-simplify.str"
          , "52"
          , "42"
          , "52"
          , "53"
          )
          ; <(s-step(
              | "strategoxt/stratego-libraries/java-backend/trans/backend-simplify.str"
              , "52"
              , "43"
              , "52"
              , "50"
              )
              ; is-upper)> c
          <+ r-exit(
             | "strategoxt/stratego-libraries/java-backend/trans/backend-simplify.str"
             , "dollar-for-capital"
             , "51"
             , "2"
             , "52"
             , "53"
             )
             ; fail

  undo-dollars-for-capitals =
    s-enter(
    | "strategoxt/stratego-libraries/java-backend/trans/backend-simplify.str"
    , "undo-dollars-for-capitals"
    , "54"
    , "2"
    , "55"
    , "34"
    )
    ; s-step(
      | "strategoxt/stratego-libraries/java-backend/trans/backend-simplify.str"
      , "55"
      , "4"
      , "55"
      , "34"
      )
    ; escape(
        s-step(
        | "strategoxt/stratego-libraries/java-backend/trans/backend-simplify.str"
        , "55"
        , "11"
        , "55"
        , "33"
        )
        ; undo-dollar-for-capital
      )
    < s-exit(
      | "strategoxt/stratego-libraries/java-backend/trans/backend-simplify.str"
      , "undo-dollars-for-capitals"
      , "54"
      , "2"
      , "55"
      , "34"
      )
    + s-exit(
      | "strategoxt/stratego-libraries/java-backend/trans/backend-simplify.str"
      , "undo-dollars-for-capitals"
      , "54"
      , "2"
      , "55"
      , "34"
      )
      ; fail

  undo-dollar-for-capital(rec) :
    ['$'|cs] -> <r-exit(
                 | "strategoxt/stratego-libraries/java-backend/trans/backend-simplify.str"
                 , "undo-dollar-for-capital"
                 , "57"
                 , "2"
                 , "58"
                 , "25"
                 )> <s-step(
                     | "strategoxt/stratego-libraries/java-backend/trans/backend-simplify.str"
                     , "58"
                     , "19"
                     , "58"
                     , "21"
                     )
                     ; rec> cs
    where r-enter(|"strategoxt/stratego-libraries/java-backend/trans/backend-simplify.str", "undo-dollar-for-capital", "57,2,58,25")
          <+ r-exit(
             | "strategoxt/stratego-libraries/java-backend/trans/backend-simplify.str"
             , "undo-dollar-for-capital"
             , "57"
             , "2"
             , "58"
             , "25"
             )
             ; fail


rules

  remove-closure-allocs =
    s-enter(
    | "strategoxt/stratego-libraries/java-backend/trans/backend-simplify.str"
    , "remove-closure-allocs"
    , "62"
    , "2"
    , "65"
    , "5"
    )
    ; s-step(
      | "strategoxt/stratego-libraries/java-backend/trans/backend-simplify.str"
      , "63"
      , "4"
      , "65"
      , "5"
      )
    ; {|RemoveClosureAlloc:
         s-step(
         | "strategoxt/stratego-libraries/java-backend/trans/backend-simplify.str"
         , "64"
         , "6"
         , "64"
         , "36"
         )
         ; alltd(
             s-step(
             | "strategoxt/stratego-libraries/java-backend/trans/backend-simplify.str"
             , "64"
             , "12"
             , "64"
             , "35"
             )
             ; remove-closure-alloc-let
           )
      |}
    < s-exit(
      | "strategoxt/stratego-libraries/java-backend/trans/backend-simplify.str"
      , "remove-closure-allocs"
      , "62"
      , "2"
      , "65"
      , "5"
      )
    + s-exit(
      | "strategoxt/stratego-libraries/java-backend/trans/backend-simplify.str"
      , "remove-closure-allocs"
      , "62"
      , "2"
      , "65"
      , "5"
      )
      ; fail

  remove-closure-alloc-let :
    Let(def*, s) -> <r-exit(
                     | "strategoxt/stratego-libraries/java-backend/trans/backend-simplify.str"
                     , "remove-closure-alloc-let"
                     , "67"
                     , "2"
                     , "73"
                     , "47"
                     )> Let(def'*, s')
    where r-enter(|"strategoxt/stratego-libraries/java-backend/trans/backend-simplify.str", "remove-closure-alloc-let", "67,2,73,47")
          <+ r-exit(
             | "strategoxt/stratego-libraries/java-backend/trans/backend-simplify.str"
             , "remove-closure-alloc-let"
             , "67"
             , "2"
             , "73"
             , "47"
             )
             ; fail
    with s-step(
         | "strategoxt/stratego-libraries/java-backend/trans/backend-simplify.str"
         , "70"
         , "6"
         , "73"
         , "47"
         )
         ; (s-step(
            | "strategoxt/stratego-libraries/java-backend/trans/backend-simplify.str"
            , "70"
            , "6"
            , "71"
            , "58"
            )
            ; def'* := <s-step(
                        | "strategoxt/stratego-libraries/java-backend/trans/backend-simplify.str"
                        , "70"
                        , "16"
                        , "70"
                        , "36"
                        )
                        ; remove-closure-allocs> <s-step(
                                                  | "strategoxt/stratego-libraries/java-backend/trans/backend-simplify.str"
                                                  , "71"
                                                  , "16"
                                                  , "71"
                                                  , "52"
                                                  )
                                                  ; filter(
                                                      s-step(
                                                      | "strategoxt/stratego-libraries/java-backend/trans/backend-simplify.str"
                                                      , "71"
                                                      , "23"
                                                      , "71"
                                                      , "51"
                                                      )
                                                      ; not(s-step(
                                                            | "strategoxt/stratego-libraries/java-backend/trans/backend-simplify.str"
                                                            , "71"
                                                            , "27"
                                                            , "71"
                                                            , "50"
                                                            )
                                                            ; remove-closure-alloc-def)
                                                    )> def*)
         ; s-step(
           | "strategoxt/stratego-libraries/java-backend/trans/backend-simplify.str"
           , "72"
           , "6"
           , "73"
           , "47"
           )
         ; s' := <s-step(
                  | "strategoxt/stratego-libraries/java-backend/trans/backend-simplify.str"
                  , "72"
                  , "13"
                  , "72"
                  , "33"
                  )
                  ; remove-closure-allocs> <s-step(
                                            | "strategoxt/stratego-libraries/java-backend/trans/backend-simplify.str"
                                            , "73"
                                            , "13"
                                            , "73"
                                            , "44"
                                            )
                                            ; alltd(
                                                s-step(
                                                | "strategoxt/stratego-libraries/java-backend/trans/backend-simplify.str"
                                                , "73"
                                                , "19"
                                                , "73"
                                                , "43"
                                                )
                                                ; remove-closure-alloc-call
                                              )> s
         <+ r-exit(
            | "strategoxt/stratego-libraries/java-backend/trans/backend-simplify.str"
            , "remove-closure-alloc-let"
            , "67"
            , "2"
            , "73"
            , "47"
            )
            ; fail

  remove-closure-alloc-def :
    SDefT(x{a*}, _, _, s) -> <r-exit(
                              | "strategoxt/stratego-libraries/java-backend/trans/backend-simplify.str"
                              , "remove-closure-alloc-def"
                              , "75"
                              , "2"
                              , "81"
                              , "39"
                              )> []
    where r-enter(|"strategoxt/stratego-libraries/java-backend/trans/backend-simplify.str", "remove-closure-alloc-def", "75,2,81,39")
          <+ r-exit(
             | "strategoxt/stratego-libraries/java-backend/trans/backend-simplify.str"
             , "remove-closure-alloc-def"
             , "75"
             , "2"
             , "81"
             , "39"
             )
             ; fail
    where s-step(
          | "strategoxt/stratego-libraries/java-backend/trans/backend-simplify.str"
          , "78"
          , "6"
          , "78"
          , "27"
          )
          ; <(s-step(
              | "strategoxt/stratego-libraries/java-backend/trans/backend-simplify.str"
              , "78"
              , "7"
              , "78"
              , "23"
              )
              ; one(s-step(
                    | "strategoxt/stratego-libraries/java-backend/trans/backend-simplify.str"
                    , "78"
                    , "11"
                    , "78"
                    , "22"
                    )
                    ; ClosureAlloc))> a*
          <+ r-exit(
             | "strategoxt/stratego-libraries/java-backend/trans/backend-simplify.str"
             , "remove-closure-alloc-def"
             , "75"
             , "2"
             , "81"
             , "39"
             )
             ; fail
    with s-step(
         | "strategoxt/stratego-libraries/java-backend/trans/backend-simplify.str"
         , "80"
         , "6"
         , "81"
         , "39"
         )
         ; (s-step(
            | "strategoxt/stratego-libraries/java-backend/trans/backend-simplify.str"
            , "80"
            , "6"
            , "80"
            , "14"
            )
            ; x' := x{})
         ; s-step(
           | "strategoxt/stratego-libraries/java-backend/trans/backend-simplify.str"
           , "81"
           , "6"
           , "81"
           , "39"
           )
         ; rules ( RemoveClosureAlloc :
                     x' -> s )
         <+ r-exit(
            | "strategoxt/stratego-libraries/java-backend/trans/backend-simplify.str"
            , "remove-closure-alloc-def"
            , "75"
            , "2"
            , "81"
            , "39"
            )
            ; fail

  remove-closure-alloc-call :
    CallT(SVar(x), [], _) -> <r-exit(
                              | "strategoxt/stratego-libraries/java-backend/trans/backend-simplify.str"
                              , "remove-closure-alloc-call"
                              , "83"
                              , "2"
                              , "86"
                              , "39"
                              )> inline
    where r-enter(|"strategoxt/stratego-libraries/java-backend/trans/backend-simplify.str", "remove-closure-alloc-call", "83,2,86,39")
          <+ r-exit(
             | "strategoxt/stratego-libraries/java-backend/trans/backend-simplify.str"
             , "remove-closure-alloc-call"
             , "83"
             , "2"
             , "86"
             , "39"
             )
             ; fail
    where s-step(
          | "strategoxt/stratego-libraries/java-backend/trans/backend-simplify.str"
          , "86"
          , "6"
          , "86"
          , "39"
          )
          ; (s-step(
             | "strategoxt/stratego-libraries/java-backend/trans/backend-simplify.str"
             , "86"
             , "6"
             , "86"
             , "29"
             )
             ; <(s-step(
                 | "strategoxt/stratego-libraries/java-backend/trans/backend-simplify.str"
                 , "86"
                 , "7"
                 , "86"
                 , "24"
                 )
                 ; RemoveClosureAlloc)> x{}) => inline
          <+ r-exit(
             | "strategoxt/stratego-libraries/java-backend/trans/backend-simplify.str"
             , "remove-closure-alloc-call"
             , "83"
             , "2"
             , "86"
             , "39"
             )
             ; fail