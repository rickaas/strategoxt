module optimizer

imports
  org.strategoxt.imp.debuggers.stratego.runtime


imports
  Stratego
  stratego/strc/opt/stratego-laws
  libstratego-lib


strategies
  olevel(n, s) =
    s-enter(|"strategoxt/stratego-libraries/strc/lib/stratego/strc/opt/optimizer.str", "olevel", "12,2,13,47")
    ; s-step(|"strategoxt/stratego-libraries/strc/lib/stratego/strc/opt/optimizer.str", "13,4,13,47")
    ; try(
        s-step(|"strategoxt/stratego-libraries/strc/lib/stratego/strc/opt/optimizer.str", "13,8,13,46")
        ; (s-step(|"strategoxt/stratego-libraries/strc/lib/stratego/strc/opt/optimizer.str", "13,8,13,43")
           ; where(s-step(|"strategoxt/stratego-libraries/strc/lib/stratego/strc/opt/optimizer.str", "13,14,13,42")
                   ; <(s-step(|"strategoxt/stratego-libraries/strc/lib/stratego/strc/opt/optimizer.str", "13,15,13,17") ; geq)> ( <s-step(|"strategoxt/stratego-libraries/strc/lib/stratego/strc/opt/optimizer.str", "13,21,13,30") ; get-config> "-O"
                                                                                                                                , <s-step(|"strategoxt/stratego-libraries/strc/lib/stratego/strc/opt/optimizer.str", "13,40,13,40") ; n>
                                                                                                                                )))
        ; s-step(|"strategoxt/stratego-libraries/strc/lib/stratego/strc/opt/optimizer.str", "13,46,13,46")
        ; s
      )
    < s-exit(|"strategoxt/stratego-libraries/strc/lib/stratego/strc/opt/optimizer.str", "olevel", "12,2,13,47")
    + s-exit(|"strategoxt/stratego-libraries/strc/lib/stratego/strc/opt/optimizer.str", "olevel", "12,2,13,47")
      ; fail

  olevel1(s) =
    s-enter(|"strategoxt/stratego-libraries/strc/lib/stratego/strc/opt/optimizer.str", "olevel1", "15,2,15,27")
    ; s-step(|"strategoxt/stratego-libraries/strc/lib/stratego/strc/opt/optimizer.str", "15,15,15,27")
    ; olevel(
        s-step(|"strategoxt/stratego-libraries/strc/lib/stratego/strc/opt/optimizer.str", "15,22,15,23")
        ; !1
      , s-step(|"strategoxt/stratego-libraries/strc/lib/stratego/strc/opt/optimizer.str", "15,26,15,26") ; s
      )
    < s-exit(|"strategoxt/stratego-libraries/strc/lib/stratego/strc/opt/optimizer.str", "olevel1", "15,2,15,27")
    + s-exit(|"strategoxt/stratego-libraries/strc/lib/stratego/strc/opt/optimizer.str", "olevel1", "15,2,15,27")
      ; fail

  olevel2(s) =
    s-enter(|"strategoxt/stratego-libraries/strc/lib/stratego/strc/opt/optimizer.str", "olevel2", "16,2,16,27")
    ; s-step(|"strategoxt/stratego-libraries/strc/lib/stratego/strc/opt/optimizer.str", "16,15,16,27")
    ; olevel(
        s-step(|"strategoxt/stratego-libraries/strc/lib/stratego/strc/opt/optimizer.str", "16,22,16,23")
        ; !2
      , s-step(|"strategoxt/stratego-libraries/strc/lib/stratego/strc/opt/optimizer.str", "16,26,16,26") ; s
      )
    < s-exit(|"strategoxt/stratego-libraries/strc/lib/stratego/strc/opt/optimizer.str", "olevel2", "16,2,16,27")
    + s-exit(|"strategoxt/stratego-libraries/strc/lib/stratego/strc/opt/optimizer.str", "olevel2", "16,2,16,27")
      ; fail

  olevel3(s) =
    s-enter(|"strategoxt/stratego-libraries/strc/lib/stratego/strc/opt/optimizer.str", "olevel3", "17,2,17,27")
    ; s-step(|"strategoxt/stratego-libraries/strc/lib/stratego/strc/opt/optimizer.str", "17,15,17,27")
    ; olevel(
        s-step(|"strategoxt/stratego-libraries/strc/lib/stratego/strc/opt/optimizer.str", "17,22,17,23")
        ; !3
      , s-step(|"strategoxt/stratego-libraries/strc/lib/stratego/strc/opt/optimizer.str", "17,26,17,26") ; s
      )
    < s-exit(|"strategoxt/stratego-libraries/strc/lib/stratego/strc/opt/optimizer.str", "olevel3", "17,2,17,27")
    + s-exit(|"strategoxt/stratego-libraries/strc/lib/stratego/strc/opt/optimizer.str", "olevel3", "17,2,17,27")
      ; fail

  olevel4(s) =
    s-enter(|"strategoxt/stratego-libraries/strc/lib/stratego/strc/opt/optimizer.str", "olevel4", "18,2,18,27")
    ; s-step(|"strategoxt/stratego-libraries/strc/lib/stratego/strc/opt/optimizer.str", "18,15,18,27")
    ; olevel(
        s-step(|"strategoxt/stratego-libraries/strc/lib/stratego/strc/opt/optimizer.str", "18,22,18,23")
        ; !4
      , s-step(|"strategoxt/stratego-libraries/strc/lib/stratego/strc/opt/optimizer.str", "18,26,18,26") ; s
      )
    < s-exit(|"strategoxt/stratego-libraries/strc/lib/stratego/strc/opt/optimizer.str", "olevel4", "18,2,18,27")
    + s-exit(|"strategoxt/stratego-libraries/strc/lib/stratego/strc/opt/optimizer.str", "olevel4", "18,2,18,27")
      ; fail

  olevel5(s) =
    s-enter(|"strategoxt/stratego-libraries/strc/lib/stratego/strc/opt/optimizer.str", "olevel5", "19,2,19,27")
    ; s-step(|"strategoxt/stratego-libraries/strc/lib/stratego/strc/opt/optimizer.str", "19,15,19,27")
    ; olevel(
        s-step(|"strategoxt/stratego-libraries/strc/lib/stratego/strc/opt/optimizer.str", "19,22,19,23")
        ; !5
      , s-step(|"strategoxt/stratego-libraries/strc/lib/stratego/strc/opt/optimizer.str", "19,26,19,26") ; s
      )
    < s-exit(|"strategoxt/stratego-libraries/strc/lib/stratego/strc/opt/optimizer.str", "olevel5", "19,2,19,27")
    + s-exit(|"strategoxt/stratego-libraries/strc/lib/stratego/strc/opt/optimizer.str", "olevel5", "19,2,19,27")
      ; fail

  olevel6(s) =
    s-enter(|"strategoxt/stratego-libraries/strc/lib/stratego/strc/opt/optimizer.str", "olevel6", "20,2,20,27")
    ; s-step(|"strategoxt/stratego-libraries/strc/lib/stratego/strc/opt/optimizer.str", "20,15,20,27")
    ; olevel(
        s-step(|"strategoxt/stratego-libraries/strc/lib/stratego/strc/opt/optimizer.str", "20,22,20,23")
        ; !6
      , s-step(|"strategoxt/stratego-libraries/strc/lib/stratego/strc/opt/optimizer.str", "20,26,20,26") ; s
      )
    < s-exit(|"strategoxt/stratego-libraries/strc/lib/stratego/strc/opt/optimizer.str", "olevel6", "20,2,20,27")
    + s-exit(|"strategoxt/stratego-libraries/strc/lib/stratego/strc/opt/optimizer.str", "olevel6", "20,2,20,27")
      ; fail


strategies
  fusion =
    s-enter(|"strategoxt/stratego-libraries/strc/lib/stratego/strc/opt/optimizer.str", "fusion", "24,2,26,28")
    ; s-step(|"strategoxt/stratego-libraries/strc/lib/stratego/strc/opt/optimizer.str", "25,4,26,28")
    ; (s-step(|"strategoxt/stratego-libraries/strc/lib/stratego/strc/opt/optimizer.str", "25,4,25,23") ; declare-inline-rules)
    ; s-step(|"strategoxt/stratego-libraries/strc/lib/stratego/strc/opt/optimizer.str", "26,6,26,28")
    ; alltd(
        s-step(|"strategoxt/stratego-libraries/strc/lib/stratego/strc/opt/optimizer.str", "26,12,26,27") ; innermost-fusion
      )
    < s-exit(|"strategoxt/stratego-libraries/strc/lib/stratego/strc/opt/optimizer.str", "fusion", "24,2,26,28")
    + s-exit(|"strategoxt/stratego-libraries/strc/lib/stratego/strc/opt/optimizer.str", "fusion", "24,2,26,28")
      ; fail

  do-inline =
    s-enter(|"strategoxt/stratego-libraries/strc/lib/stratego/strc/opt/optimizer.str", "do-inline", "30,2,31,20")
    ; s-step(|"strategoxt/stratego-libraries/strc/lib/stratego/strc/opt/optimizer.str", "31,4,31,20")
    ; inline-strategies
    < s-exit(|"strategoxt/stratego-libraries/strc/lib/stratego/strc/opt/optimizer.str", "do-inline", "30,2,31,20")
    + s-exit(|"strategoxt/stratego-libraries/strc/lib/stratego/strc/opt/optimizer.str", "do-inline", "30,2,31,20")
      ; fail

  dead-def-elim =
    s-enter(|"strategoxt/stratego-libraries/strc/lib/stratego/strc/opt/optimizer.str", "dead-def-elim", "33,2,35,23")
    ; s-step(|"strategoxt/stratego-libraries/strc/lib/stratego/strc/opt/optimizer.str", "34,4,35,23")
    ; (s-step(|"strategoxt/stratego-libraries/strc/lib/stratego/strc/opt/optimizer.str", "34,4,34,50")
       ; if-lib(
           s-step(|"strategoxt/stratego-libraries/strc/lib/stratego/strc/opt/optimizer.str", "34,11,34,49")
           ; where(s-step(|"strategoxt/stratego-libraries/strc/lib/stratego/strc/opt/optimizer.str", "34,17,34,48")
                   ; <(s-step(|"strategoxt/stratego-libraries/strc/lib/stratego/strc/opt/optimizer.str", "34,18,34,27") ; set-config)> ("--only-local", ()))
         ))
    ; s-step(|"strategoxt/stratego-libraries/strc/lib/stratego/strc/opt/optimizer.str", "35,6,35,23")
    ; dead-def-elim-spec
    < s-exit(|"strategoxt/stratego-libraries/strc/lib/stratego/strc/opt/optimizer.str", "dead-def-elim", "33,2,35,23")
    + s-exit(|"strategoxt/stratego-libraries/strc/lib/stratego/strc/opt/optimizer.str", "dead-def-elim", "33,2,35,23")
      ; fail

  compile-match =
    s-enter(|"strategoxt/stratego-libraries/strc/lib/stratego/strc/opt/optimizer.str", "compile-match", "37,2,38,32")
    ; s-step(|"strategoxt/stratego-libraries/strc/lib/stratego/strc/opt/optimizer.str", "38,4,38,32")
    ; apply-to-bodies(
        s-step(|"strategoxt/stratego-libraries/strc/lib/stratego/strc/opt/optimizer.str", "38,20,38,31") ; match-to-dfa
      )
    < s-exit(|"strategoxt/stratego-libraries/strc/lib/stratego/strc/opt/optimizer.str", "compile-match", "37,2,38,32")
    + s-exit(|"strategoxt/stratego-libraries/strc/lib/stratego/strc/opt/optimizer.str", "compile-match", "37,2,38,32")
      ; fail

  bound-unbound-var =
    s-enter(|"strategoxt/stratego-libraries/strc/lib/stratego/strc/opt/optimizer.str", "bound-unbound-var", "40,2,41,26")
    ; s-step(|"strategoxt/stratego-libraries/strc/lib/stratego/strc/opt/optimizer.str", "41,4,41,26")
    ; mark-bound-unbound-vars
    < s-exit(|"strategoxt/stratego-libraries/strc/lib/stratego/strc/opt/optimizer.str", "bound-unbound-var", "40,2,41,26")
    + s-exit(|"strategoxt/stratego-libraries/strc/lib/stratego/strc/opt/optimizer.str", "bound-unbound-var", "40,2,41,26")
      ; fail

  optimizer =
    s-enter(|"strategoxt/stratego-libraries/strc/lib/stratego/strc/opt/optimizer.str", "optimizer", "43,2,86,6")
    ; s-step(|"strategoxt/stratego-libraries/strc/lib/stratego/strc/opt/optimizer.str", "44,4,86,6")
    ; (s-step(|"strategoxt/stratego-libraries/strc/lib/stratego/strc/opt/optimizer.str", "44,4,49,4")
       ; olevel1(
           s-step(|"strategoxt/stratego-libraries/strc/lib/stratego/strc/opt/optimizer.str", "45,6,48,6")
           ; try(
               s-step(|"strategoxt/stratego-libraries/strc/lib/stratego/strc/opt/optimizer.str", "45,10,46,13")
               ; (s-step(|"strategoxt/stratego-libraries/strc/lib/stratego/strc/opt/optimizer.str", "45,10,45,44")
                  ; where(s-step(|"strategoxt/stratego-libraries/strc/lib/stratego/strc/opt/optimizer.str", "45,16,45,43")
                          ; not(s-step(|"strategoxt/stratego-libraries/strc/lib/stratego/strc/opt/optimizer.str", "45,20,45,42")
                                ; <(s-step(|"strategoxt/stratego-libraries/strc/lib/stratego/strc/opt/optimizer.str", "45,21,45,30") ; get-config)> "--fusion")))
               ; s-step(|"strategoxt/stratego-libraries/strc/lib/stratego/strc/opt/optimizer.str", "46,8,46,13")
               ; fusion
             )
         ))
    ; s-step(|"strategoxt/stratego-libraries/strc/lib/stratego/strc/opt/optimizer.str", "53,6,86,6")
    ; (s-step(|"strategoxt/stratego-libraries/strc/lib/stratego/strc/opt/optimizer.str", "53,6,61,6")
       ; olevel2(
           s-step(|"strategoxt/stratego-libraries/strc/lib/stratego/strc/opt/optimizer.str", "54,1,60,11")
           ; (s-step(|"strategoxt/stratego-libraries/strc/lib/stratego/strc/opt/optimizer.str", "54,1,54,19") ; worker-wrapper-spec)
           ; s-step(|"strategoxt/stratego-libraries/strc/lib/stratego/strc/opt/optimizer.str", "56,3,60,11")
           ; (s-step(|"strategoxt/stratego-libraries/strc/lib/stratego/strc/opt/optimizer.str", "56,3,56,11") ; do-inline)
           ; s-step(|"strategoxt/stratego-libraries/strc/lib/stratego/strc/opt/optimizer.str", "58,3,60,11")
           ; (s-step(|"strategoxt/stratego-libraries/strc/lib/stratego/strc/opt/optimizer.str", "58,3,58,15") ; dead-def-elim)
           ; s-step(|"strategoxt/stratego-libraries/strc/lib/stratego/strc/opt/optimizer.str", "60,3,60,11")
           ; simplify1
         ))
    ; s-step(|"strategoxt/stratego-libraries/strc/lib/stratego/strc/opt/optimizer.str", "74,6,86,6")
    ; (s-step(|"strategoxt/stratego-libraries/strc/lib/stratego/strc/opt/optimizer.str", "74,6,78,6")
       ; olevel4(
           s-step(|"strategoxt/stratego-libraries/strc/lib/stratego/strc/opt/optimizer.str", "75,1,76,14")
           ; (s-step(|"strategoxt/stratego-libraries/strc/lib/stratego/strc/opt/optimizer.str", "75,1,75,13") ; compile-match)
           ; s-step(|"strategoxt/stratego-libraries/strc/lib/stratego/strc/opt/optimizer.str", "76,3,76,14")
           ; desugar-case
         ))
    ; s-step(|"strategoxt/stratego-libraries/strc/lib/stratego/strc/opt/optimizer.str", "81,6,86,6")
    ; olevel5(
        s-step(|"strategoxt/stratego-libraries/strc/lib/stratego/strc/opt/optimizer.str", "82,1,84,15")
        ; (s-step(|"strategoxt/stratego-libraries/strc/lib/stratego/strc/opt/optimizer.str", "82,1,82,9") ; do-inline)
        ; s-step(|"strategoxt/stratego-libraries/strc/lib/stratego/strc/opt/optimizer.str", "84,3,84,15")
        ; dead-def-elim
      )
    < s-exit(|"strategoxt/stratego-libraries/strc/lib/stratego/strc/opt/optimizer.str", "optimizer", "43,2,86,6")
    + s-exit(|"strategoxt/stratego-libraries/strc/lib/stratego/strc/opt/optimizer.str", "optimizer", "43,2,86,6")
      ; fail