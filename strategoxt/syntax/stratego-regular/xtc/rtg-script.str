module rtg-script

imports
  org.strategoxt.imp.debuggers.stratego.runtime


imports
  libstratego-lib
  libstratego-xtc
  libstratego-rtg
  regular-xtc-tools
  tool-doc


signature
  constructors
                  : List(RTGCommand) -> RTGScript
    Read          : String -> RTGCommand
    Include       : List(RTGCommand) -> RTGCommand
    DeleteNonterm : String -> RTGCommand
    DeleteTerm    : String * String -> RTGCommand
    DeleteTerm    : String -> RTGCommand
    Reduce        : RTGCommand
    Group         : RTGCommand


strategies
  main-rtg-script =
    s-enter(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "main-rtg-script", "24,2,33,4")
    ; s-step(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "25,4,33,4")
    ; xtc-io-wrap(
        s-step(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "26,6,26,19") ; include-option
      , s-step(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "27,6,27,21") ; rtg-script-usage
      , s-step(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "28,6,28,21") ; rtg-script-about
      , s-step(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "29,6,29,8")
        ; ![]
      , s-step(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "30,6,32,17")
        ; (s-step(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "30,6,30,14") ; read-from)
        ; s-step(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "31,8,32,17")
        ; (s-step(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "31,8,31,22") ; rtg-script-eval)
        ; s-step(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "32,8,32,17")
        ; xtc-pp-rtg
      )
    < s-exit(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "main-rtg-script", "24,2,33,4")
    + s-exit(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "main-rtg-script", "24,2,33,4")
      ; fail


strategies
  rtg-script-eval =
    s-enter(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "rtg-script-eval", "37,2,39,24")
    ; s-step(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "38,4,39,24")
    ; (s-step(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "38,4,38,14")
       ; !( <s-step(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "38,7,38,8") ; id>
          , ()
          ))
    ; s-step(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "39,6,39,24")
    ; foldl(
        s-step(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "39,12,39,23") ; eval-command
      )
    < s-exit(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "rtg-script-eval", "37,2,39,24")
    + s-exit(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "rtg-script-eval", "37,2,39,24")
      ; fail


rules

  eval-command :
    (Read(file), ()) -> <r-exit(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "eval-command", "43,2,45,68")> <s-step(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "45,7,45,52")
                                                                                                                          ; (s-step(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "45,7,45,18") ; conc-strings)
                                                                                                                          ; s-step(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "45,21,45,52")
                                                                                                                          ; (s-step(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "45,21,45,36") ; find-in-includes)
                                                                                                                          ; s-step(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "45,39,45,52")
                                                                                                                          ; parse-rtg-file> (file, ".rtg")
    where r-enter(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "eval-command", "43,2,45,68")
          <+ r-exit(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "eval-command", "43,2,45,68")
             ; fail

  eval-command :
    (Reduce(), rtg) -> <r-exit(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "eval-command", "47,2,48,38")> <s-step(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "48,24,48,33") ; rtg-reduce> rtg
    where r-enter(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "eval-command", "47,2,48,38")
          <+ r-exit(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "eval-command", "47,2,48,38")
             ; fail

  eval-command :
    (Group(), rtg) -> <r-exit(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "eval-command", "50,2,51,48")> <s-step(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "51,23,51,43") ; rtg-group-productions> rtg
    where r-enter(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "eval-command", "50,2,51,48")
          <+ r-exit(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "eval-command", "50,2,51,48")
             ; fail

  eval-command :
    (DeleteNonterm(s), rtg) -> <r-exit(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "eval-command", "53,2,59,10")> <s-step(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "55,8,58,8")
                                                                                                                                 ; RTG(
                                                                                                                                     s-step(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "56,10,56,40")
                                                                                                                                     ; Start(
                                                                                                                                         s-step(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "56,16,56,39")
                                                                                                                                         ; filter(
                                                                                                                                             s-step(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "56,23,56,38")
                                                                                                                                             ; not(s-step(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "56,27,56,37")
                                                                                                                                                   ; ?Nonterm(s))
                                                                                                                                           )
                                                                                                                                       )
                                                                                                                                   , s-step(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "57,10,57,57")
                                                                                                                                     ; ProdRules(
                                                                                                                                         s-step(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "57,20,57,56")
                                                                                                                                         ; filter(
                                                                                                                                             s-step(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "57,27,57,55")
                                                                                                                                             ; not(s-step(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "57,31,57,54")
                                                                                                                                                   ; ?ProdRule(Nonterm(s), _))
                                                                                                                                           )
                                                                                                                                       )
                                                                                                                                   )> rtg
    where r-enter(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "eval-command", "53,2,59,10")
          <+ r-exit(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "eval-command", "53,2,59,10")
             ; fail

  eval-command :
    (DeleteTerm(nt, t), rtg) -> <r-exit(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "eval-command", "61,2,72,10")> <s-step(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "63,8,71,8")
                                                                                                                                  ; RTG(
                                                                                                                                      s-step(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "64,10,64,11") ; id
                                                                                                                                    , s-step(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "65,10,70,10")
                                                                                                                                      ; ProdRules(
                                                                                                                                          s-step(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "66,12,69,40")
                                                                                                                                          ; (s-step(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "66,12,68,12")
                                                                                                                                             ; map(
                                                                                                                                                 s-step(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "67,14,67,65")
                                                                                                                                                 ; try(
                                                                                                                                                     s-step(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "67,18,67,64")
                                                                                                                                                     ; ProdRule(
                                                                                                                                                         s-step(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "67,27,67,38")
                                                                                                                                                         ; ?Nonterm(nt)
                                                                                                                                                       , s-step(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "67,41,67,63")
                                                                                                                                                         ; filter(
                                                                                                                                                             s-step(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "67,48,67,62")
                                                                                                                                                             ; not(s-step(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "67,52,67,61")
                                                                                                                                                                   ; oncetd(
                                                                                                                                                                       s-step(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "67,59,67,60") ; ?t
                                                                                                                                                                     ))
                                                                                                                                                           )
                                                                                                                                                       )
                                                                                                                                                   )
                                                                                                                                               ))
                                                                                                                                          ; s-step(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "69,12,69,40")
                                                                                                                                          ; filter(
                                                                                                                                              s-step(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "69,19,69,39")
                                                                                                                                              ; not(s-step(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "69,23,69,38")
                                                                                                                                                    ; ProdRule(
                                                                                                                                                        s-step(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "69,32,69,33") ; id
                                                                                                                                                      , s-step(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "69,36,69,37") ; []
                                                                                                                                                      ))
                                                                                                                                            )
                                                                                                                                        )
                                                                                                                                    )> rtg
    where r-enter(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "eval-command", "61,2,72,10")
          <+ r-exit(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "eval-command", "61,2,72,10")
             ; fail

  eval-command :
    (DeleteTerm(t), rtg) -> <r-exit(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "eval-command", "74,2,85,10")> <s-step(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "76,8,84,8")
                                                                                                                              ; RTG(
                                                                                                                                  s-step(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "77,10,77,11") ; id
                                                                                                                                , s-step(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "78,10,83,10")
                                                                                                                                  ; ProdRules(
                                                                                                                                      s-step(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "79,12,82,40")
                                                                                                                                      ; (s-step(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "79,12,81,12")
                                                                                                                                         ; map(
                                                                                                                                             s-step(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "80,14,80,55")
                                                                                                                                             ; try(
                                                                                                                                                 s-step(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "80,18,80,54")
                                                                                                                                                 ; ProdRule(
                                                                                                                                                     s-step(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "80,27,80,28") ; id
                                                                                                                                                   , s-step(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "80,31,80,53")
                                                                                                                                                     ; filter(
                                                                                                                                                         s-step(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "80,38,80,52")
                                                                                                                                                         ; not(s-step(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "80,42,80,51")
                                                                                                                                                               ; oncetd(
                                                                                                                                                                   s-step(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "80,49,80,50") ; ?t
                                                                                                                                                                 ))
                                                                                                                                                       )
                                                                                                                                                   )
                                                                                                                                               )
                                                                                                                                           ))
                                                                                                                                      ; s-step(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "82,12,82,40")
                                                                                                                                      ; filter(
                                                                                                                                          s-step(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "82,19,82,39")
                                                                                                                                          ; not(s-step(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "82,23,82,38")
                                                                                                                                                ; ProdRule(
                                                                                                                                                    s-step(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "82,32,82,33") ; id
                                                                                                                                                  , s-step(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "82,36,82,37") ; []
                                                                                                                                                  ))
                                                                                                                                        )
                                                                                                                                    )
                                                                                                                                )> rtg
    where r-enter(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "eval-command", "74,2,85,10")
          <+ r-exit(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "eval-command", "74,2,85,10")
             ; fail

  eval-command :
    (Include(cmds), rtg) -> <r-exit(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "eval-command", "87,2,93,50")> <s-step(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "89,8,89,79")
                                                                                                                              ; RTG(
                                                                                                                                  s-step(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "89,12,89,40")
                                                                                                                                  ; Start(
                                                                                                                                      s-step(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "89,18,89,39")
                                                                                                                                      ; <(s-step(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "89,19,89,23") ; union)> ( starts
                                                                                                                                                                                                                                    , <s-step(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "89,36,89,37") ; id>
                                                                                                                                                                                                                                    )
                                                                                                                                    )
                                                                                                                                , s-step(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "89,43,89,78")
                                                                                                                                  ; ProdRules(
                                                                                                                                      s-step(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "89,53,89,77")
                                                                                                                                      ; <(s-step(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "89,54,89,57") ; conc)> ( <s-step(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "89,62,89,63") ; id>
                                                                                                                                                                                                                                   , prod-rules
                                                                                                                                                                                                                                   )
                                                                                                                                    )
                                                                                                                                )> rtg
    where r-enter(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "eval-command", "87,2,93,50")
          <+ r-exit(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "eval-command", "87,2,93,50")
             ; fail
    where s-step(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "92,7,93,50")
          ; (s-step(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "92,7,92,28")
             ; <(s-step(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "92,8,92,22") ; rtg-script-eval)> cmds)
          ; s-step(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "93,9,93,50")
          ; ?RTG(Start(starts), ProdRules(prod-rules))
          <+ r-exit(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "eval-command", "87,2,93,50")
             ; fail


strategies
  include-option =
    s-enter(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "include-option", "97,2,101,4")
    ; s-step(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "98,4,101,4")
    ; ArgOption(
        s-step(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "98,14,98,31")
        ; (s-step(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "98,14,98,17") ; "-I"
           + s-step(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "98,21,98,31") ; "--Include")
      , s-step(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "99,6,99,40")
        ; <(s-step(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "99,7,99,24") ; post-extend-config)> ( "-I"
                                                                                                                  , [<s-step(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "99,36,99,37") ; id>]
                                                                                                                  )
      , s-step(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "100,6,100,69")
        ; !HelpString("-I d|--Include d", "Include RTGs from directory d")
      )
    < s-exit(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "include-option", "97,2,101,4")
    + s-exit(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "include-option", "97,2,101,4")
      ; fail

  find-in-includes =
    s-enter(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "find-in-includes", "106,2,108,70")
    ; s-step(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "107,4,108,70")
    ; (s-step(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "107,4,107,40")
       ; <(s-step(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "107,5,107,16") ; find-in-path)> ( <s-step(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "107,21,107,22") ; id>
                                                                                                             , <s-step(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "107,27,107,38") ; get-includes>
                                                                                                             )
       <+ s-step(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "108,7,108,70")
          ; where(s-step(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "108,13,108,69")
                  ; <(s-step(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "108,14,108,24") ; fatal-error)> [ "rtg-script: file '"
                                                                                                                        , <s-step(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "108,51,108,52") ; id>
                                                                                                                        , "' not found"
                                                                                                                        ]))
    < s-exit(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "find-in-includes", "106,2,108,70")
    + s-exit(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "find-in-includes", "106,2,108,70")
      ; fail

  get-includes =
    s-enter(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "get-includes", "110,2,111,46")
    ; s-step(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "111,4,111,46")
    ; (s-step(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "111,4,111,36")
       ; <(s-step(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "111,5,111,8") ; conc)> ( <s-step(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "111,13,111,22") ; get-config> "-I"
                                                                                                    , ["."]
                                                                                                    )
       <+ s-step(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "111,41,111,46")
          ; !["."])
    < s-exit(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "get-includes", "110,2,111,46")
    + s-exit(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "get-includes", "110,2,111,46")
      ; fail


strategies
  rtg-script-usage =
    s-enter(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "rtg-script-usage", "115,2,121,6")
    ; s-step(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "116,4,121,6")
    ; <(s-step(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "116,5,116,12") ; tool-doc)> [ Usage("rtg-script -i file [OPTIONS]")
                                                                                                      , Summary("Produces an RTG by executing an RTG script")
                                                                                                      , OptionUsage()
                                                                                                      , AutoReportBugs()
                                                                                                      ]
    < s-exit(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "rtg-script-usage", "115,2,121,6")
    + s-exit(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "rtg-script-usage", "115,2,121,6")
      ; fail

  rtg-script-about =
    s-enter(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "rtg-script-about", "123,2,132,6")
    ; s-step(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "124,4,132,6")
    ; <(s-step(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "124,5,124,12") ; tool-doc)> [ AutoProgram()
                                                                                                      , Author(Person("Martin Bravenboer", "martin.bravenboer@gmail.com"))
                                                                                                      , GNU_LGPL("2002-2008", "Martin Bravenboer <martin.bravenboer@gmail.com>")
                                                                                                      , Config([DefaultXTCRepository(), CurrentXTCRepository()])
                                                                                                      ]
    < s-exit(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "rtg-script-about", "123,2,132,6")
    + s-exit(|"strategoxt/syntax/stratego-regular/xtc/rtg-script.str", "rtg-script-about", "123,2,132,6")
      ; fail